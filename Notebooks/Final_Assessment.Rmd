---
title: "CoViD_in_HH_final_v0.1"
author: "John-Philipp Vogt"
date: "29/04/2022"
output: html_document
---

# 0 Packages and Scripts

Script runs: Load `tidyverse`, load `RKI_imptran`, `RKI_geofil`, `df_age_bracket_ref_date` and `df_age_bracket_rep_date`.

```{r}
library(tidyverse)
library(gridExtra)

RKI_imptran <- function(x){
  read_csv(x, col_types = list(
    Altersgruppe = col_factor(),
    Geschlecht = col_factor(),
    IstErkrankungsbeginn = col_logical()
  )) %>%
    rename(geo_ID = IdLandkreis,age_group = Altersgruppe,
           sex = Geschlecht, rep_date = Meldedatum,
           ref_date = Refdatum, ref_rep_date = IstErkrankungsbeginn,
           amount_case = AnzahlFall, amount_death = AnzahlTodesfall,
           amount_recovery = AnzahlGenesen, new_case = NeuerFall,
           new_death = NeuerTodesfall, new_recovery = NeuGenesen)
}

RKI_geofil <- function(x, y){
  x %>% filter(geo_ID == y)
}

df_age_brackets_ref_date <- function(){
  A0 <- inf_HH %>% select(ref_date, age_group, amount_case) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "unbekannt") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A1 <- inf_HH %>% select(ref_date, age_group, amount_case) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A00-A04") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A2 <- inf_HH %>% select(ref_date, age_group, amount_case) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A05-A14") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A3 <- inf_HH %>% select(ref_date, age_group, amount_case) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A15-A34") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A4 <- inf_HH %>% select(ref_date, age_group, amount_case) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A35-A59") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A5 <- inf_HH %>% select(ref_date, age_group, amount_case) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A60-A79") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A6 <- inf_HH %>% select(ref_date, age_group, amount_case) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A80+") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
    rbind(A0, A1, A2, A3, A4, A5, A6)
}

df_age_brackets_rep_date <- function(){
  A0 <- inf_HH %>% select(rep_date, age_group, amount_case) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "unbekannt") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A1 <- inf_HH %>% select(rep_date, age_group, amount_case) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A00-A04") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A2 <- inf_HH %>% select(rep_date, age_group, amount_case) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A05-A14") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A3 <- inf_HH %>% select(rep_date, age_group, amount_case) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A15-A34") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A4 <- inf_HH %>% select(rep_date, age_group, amount_case) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A35-A59") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A5 <- inf_HH %>% select(rep_date, age_group, amount_case) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A60-A79") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  A6 <- inf_HH %>% select(rep_date, age_group, amount_case) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(age_group == "A80+") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  rbind(A0, A1, A2, A3, A4, A5, A6)
}

df_sex_ref_date <- function(){
  
  M <- inf_HH %>% select(ref_date, sex, amount_case) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, sex) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(sex == "M") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_case))

  W <- inf_HH %>% select(ref_date, sex, amount_case) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, sex) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(sex == "W") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_case))

  unbekannt <- inf_HH %>% select(ref_date, sex, amount_case) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, sex) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(sex == "unbekannt") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_case))

  df_sex_ref_date <- rbind(M, W, unbekannt)
}

df_sex_rep_date <- function(){
  
  M <- inf_HH %>% select(rep_date, sex, amount_case) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, sex) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(sex == "M") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  W <- inf_HH %>% select(rep_date, sex, amount_case) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, sex) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(sex == "W") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  unbekannt <- inf_HH %>% select(rep_date, sex, amount_case) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, sex) %>% 
    summarise(amount_case = sum(amount_case)) %>% 
    ungroup %>% 
    filter(sex == "unbekannt") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_case))
  
  df_sex_rep_date <- rbind(M, W, unbekannt)
}

df_age_brackets_ref_date_deaths <- function(){
  A0 <- inf_HH %>% select(ref_date, age_group, amount_death) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "unbekannt") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A1 <- inf_HH %>% select(ref_date, age_group, amount_death) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A00-A04") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A2 <- inf_HH %>% select(ref_date, age_group, amount_death) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A05-A14") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A3 <- inf_HH %>% select(ref_date, age_group, amount_death) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A15-A34") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A4 <- inf_HH %>% select(ref_date, age_group, amount_death) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A35-A59") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A5 <- inf_HH %>% select(ref_date, age_group, amount_death) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A60-A79") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A6 <- inf_HH %>% select(ref_date, age_group, amount_death) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A80+") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  rbind(A0, A1, A2, A3, A4, A5, A6)
}

df_age_brackets_rep_date_deaths <- function(){
  A0 <- inf_HH %>% select(rep_date, age_group, amount_death) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "unbekannt") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A1 <- inf_HH %>% select(rep_date, age_group, amount_death) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A00-A04") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A2 <- inf_HH %>% select(rep_date, age_group, amount_death) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A05-A14") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A3 <- inf_HH %>% select(rep_date, age_group, amount_death) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A15-A34") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A4 <- inf_HH %>% select(rep_date, age_group, amount_death) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A35-A59") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A5 <- inf_HH %>% select(rep_date, age_group, amount_death) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A60-A79") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  A6 <- inf_HH %>% select(rep_date, age_group, amount_death) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(age_group == "A80+") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  rbind(A0, A1, A2, A3, A4, A5, A6)
}

df_sex_ref_date_deaths <- function(){
  
  M <- inf_HH %>% select(ref_date, sex, amount_death) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, sex) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(sex == "M") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  W <- inf_HH %>% select(ref_date, sex, amount_death) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, sex) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(sex == "W") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  unbekannt <- inf_HH %>% select(ref_date, sex, amount_death) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, sex) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(sex == "unbekannt") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
    rbind(M, W, unbekannt)
}

df_sex_rep_date_deaths <- function(){
  
  M <- inf_HH %>% select(rep_date, sex, amount_death) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, sex) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(sex == "M") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  W <- inf_HH %>% select(rep_date, sex, amount_death) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, sex) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(sex == "W") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  unbekannt <- inf_HH %>% select(rep_date, sex, amount_death) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, sex) %>% 
    summarise(amount_death = sum(amount_death)) %>% 
    ungroup %>% 
    filter(sex == "unbekannt") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_death))
  
  rbind(M, W, unbekannt)
}

df_age_brackets_ref_date_recoveries <- function(){
  A0 <- inf_HH %>% select(ref_date, age_group, amount_recovery) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "unbekannt") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A1 <- inf_HH %>% select(ref_date, age_group, amount_recovery) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A00-A04") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A2 <- inf_HH %>% select(ref_date, age_group, amount_recovery) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A05-A14") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A3 <- inf_HH %>% select(ref_date, age_group, amount_recovery) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A15-A34") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A4 <- inf_HH %>% select(ref_date, age_group, amount_recovery) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A35-A59") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A5 <- inf_HH %>% select(ref_date, age_group, amount_recovery) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A60-A79") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A6 <- inf_HH %>% select(ref_date, age_group, amount_recovery) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A80+") %>%
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  rbind(A0, A1, A2, A3, A4, A5, A6)
}

df_age_brackets_rep_date_recoveries <- function(){
  A0 <- inf_HH %>% select(rep_date, age_group, amount_recovery) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "unbekannt") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A1 <- inf_HH %>% select(rep_date, age_group, amount_recovery) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A00-A04") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A2 <- inf_HH %>% select(rep_date, age_group, amount_recovery) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A05-A14") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A3 <- inf_HH %>% select(rep_date, age_group, amount_recovery) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A15-A34") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A4 <- inf_HH %>% select(rep_date, age_group, amount_recovery) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A35-A59") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A5 <- inf_HH %>% select(rep_date, age_group, amount_recovery) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A60-A79") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  A6 <- inf_HH %>% select(rep_date, age_group, amount_recovery) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, age_group) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(age_group == "A80+") %>%
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  rbind(A0, A1, A2, A3, A4, A5, A6)
}

df_sex_ref_date_recoveries <- function(){
  
  M <- inf_HH %>% select(ref_date, sex, amount_recovery) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, sex) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(sex == "M") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  W <- inf_HH %>% select(ref_date, sex, amount_recovery) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, sex) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(sex == "W") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  unbekannt <- inf_HH %>% select(ref_date, sex, amount_recovery) %>% 
    arrange(ref_date) %>% 
    group_by(ref_date, sex) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(sex == "unbekannt") %>% 
    arrange(ref_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  rbind(M, W, unbekannt)
}

df_sex_rep_date_recoveries <- function(){
  
  M <- inf_HH %>% select(rep_date, sex, amount_recovery) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, sex) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(sex == "M") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  W <- inf_HH %>% select(rep_date, sex, amount_recovery) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, sex) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(sex == "W") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  unbekannt <- inf_HH %>% select(rep_date, sex, amount_recovery) %>% 
    arrange(rep_date) %>% 
    group_by(rep_date, sex) %>% 
    summarise(amount_recovery = sum(amount_recovery)) %>% 
    ungroup %>% 
    filter(sex == "unbekannt") %>% 
    arrange(rep_date) %>% 
    mutate(cum_cases = cumsum(amount_recovery))
  
  rbind(M, W, unbekannt)
}


```

# 1 Introducing data to R

Scripts runs: Load current `.csv`, run `RKI_imptran` and `RKI_geofil`.

```{r}
inf_FRG <- RKI_imptran("/home/jpv/Documents/Uni/D.Proc.Vis/rStudioWD/covid_frg_project/SARS-CoV-2_Infektionen_in_Deutschland/Aktuell_Deutschland_SarsCov2_Infektionen.csv")

inf_HH <- RKI_geofil(inf_FRG, 2000)
```

The following scripts load the `all_new_cases.csv`, which has to be computed after each `git pull` from the master-repo. The wd has to be the dir that contains the dataset.
The `all_new_cases.csv` may be computed with `AWK` with

```{AWK eval=FALSE, include=FALSE}
 awk -F, -f all_new_cases_FRG.awk 2*.csv > all_new_cases.csv
```

where `command.awk` is

```{AWK eval=FALSE, include=FALSE}
BEGIN{printf "IdLandkreis,Altersgruppe,Geschlecht,Meldedatum,Refdatum,IstErkrankungsbeginn,NeuerFall,NeuerTodesfall,NeuGenesen,AnzahlFall,AnzahlTodesfall,AnzahlGenesen\n"} $7 == "-1" || $7 == "1" {print $0}
```

. NB: The AWK-script is computationally rather intensive!
Then `RKI_imptran` can be invoked to read and transform `all_new_cases.csv`.

```{r}
inf_FRG_new_cases <- RKI_imptran("/home/jpv/Documents/Uni/D.Proc.Vis/rStudioWD/covid_frg_project/SARS-CoV-2_Infektionen_in_Deutschland/Archiv/all_new_cases.csv")
```

After, to filter for desired geo-location, run:

```{r}
inf_HH_new_cases <- RKI_geofil(inf_FRG_new_cases, 2000)
```

Remark: The following are computed for Hamburg only.

# 2 Rebuilding metrics

Following metrics are rebuilt:

1) Cumulative cases, deaths, and recoveries up to now
2) New cases, deaths, and recoveries each day
3) Active cases currently, and per day since start of recorded case

Where sensible they are split up in by `ref_date` and `rep_date`

## 2.1 Cumulative Cases

### Cumulative Total of Confirmed Cases
```{r}
inf_HH %>%
  transmute(total_of_confirmed_cases = sum(amount_case)) %>%
  slice_tail()
```

### Cumulative Total of Confirmed Cases (Visualised)
By `ref_date`:
```{r}
inf_HH %>% select(ref_date, amount_case) %>%
  arrange(ref_date) %>% 
  group_by(ref_date) %>% 
  summarise(amount_case = sum(amount_case)) %>%
  mutate(cumulative_cases = cumsum(amount_case)) %>%
  ggplot(aes(ref_date, cumulative_cases)) + geom_area()

cum_tot_ref_date <- inf_HH %>% select(ref_date, amount_case) %>%
  arrange(ref_date) %>% 
  group_by(ref_date) %>% 
  summarise(amount_case = sum(amount_case)) %>%
  mutate(cumulative_cases = cumsum(amount_case)) %>%
  ggplot(aes(ref_date, cumulative_cases)) + geom_area()
```
By `rep_date`:
```{r}
inf_HH %>% select(rep_date, amount_case) %>%
  arrange(rep_date) %>% 
  group_by(rep_date) %>% 
  summarise(amount_case = sum(amount_case)) %>%
  mutate(cumulative_cases = cumsum(amount_case)) %>%
  ggplot(aes(rep_date, cumulative_cases)) + geom_area()

cum_tot_rep_date <- inf_HH %>% select(rep_date, amount_case) %>%
  arrange(rep_date) %>% 
  group_by(rep_date) %>% 
  summarise(amount_case = sum(amount_case)) %>%
  mutate(cumulative_cases = cumsum(amount_case)) %>%
  ggplot(aes(rep_date, cumulative_cases)) + geom_area()
```

### Cumulative Total of Confirmed Cases by Age Bracket
```{r}
inf_HH %>%
  group_by(age_group) %>% 
  transmute(total_of_confirmed_cases = cumsum(amount_case)) %>%
  slice_tail() %>% 
  arrange(desc(total_of_confirmed_cases))
```

### Cumulative Total of Confirmed Cases by Age Bracket (Visualised)
by `ref_date`:
```{r}
AAll_ref_date <- df_age_brackets_ref_date()

AAll_ref_date %>% ggplot(aes(x = ref_date, y = cum_cases, fill = age_group)) + geom_area()

AAllplot_ref_date <- AAll_ref_date %>% ggplot(aes(x = ref_date, y = cum_cases, fill = age_group)) + geom_area(show.legend = FALSE)

```
### Total and by Age Bracket - Side-by-Side
```{r}
grid.arrange(cum_tot_ref_date, AAllplot_ref_date, nrow = 2)
```

by `rep_date`:
```{r}
AAll_rep_date <- df_age_brackets_rep_date()

AAll_rep_date %>% ggplot(aes(x = rep_date, y = cum_cases, fill = age_group)) + geom_area()

AAllplot_rep_date <- AAll_rep_date %>% ggplot(aes(x = rep_date, y = cum_cases, fill = age_group)) + geom_area(show.legend = FALSE)
```
### Total and by Age Bracket - Side-by-Side
```{r}
grid.arrange(cum_tot_rep_date, AAllplot_rep_date, nrow = 2)
```

### Total of Confirmed Cases by Age Bracket (Visualised)
```{r}
inf_HH %>% select(age_group, amount_case) %>%
  group_by(age_group) %>%
  summarise(sum = sum(amount_case)) %>%
  ggplot(aes(fct_reorder(age_group, sum), sum)) + geom_col()
```
### Total of Confirmed Cases by Sex
```{r}
inf_HH %>%
  group_by(sex) %>% 
  transmute(total_of_confirmed_cases = cumsum(amount_case)) %>%
  slice_tail() %>% 
  arrange(desc(total_of_confirmed_cases))
```

### Cumulative Total of Confirmed Cases by Sex (Visualised)
By `ref_date`:
```{r}
sex_ref_date <- df_sex_ref_date()

sex_ref_date %>% ggplot(aes(x = ref_date, y = cum_cases, fill = sex)) + geom_area()

sexplot_ref_date <- sex_ref_date %>% ggplot(aes(x = ref_date, y = cum_cases, fill = sex)) + geom_area(show.legend = FALSE)
```
### Total by Sex Side-by-Side (Visualised)
```{r}
grid.arrange(cum_tot_ref_date, sexplot_ref_date, nrow = 2)
```

By `rep_date`:
```{r}
sex_rep_date <- df_sex_rep_date()

sex_rep_date %>% ggplot(aes(x = rep_date, y = cum_cases, fill = sex)) + geom_area()

sexplot_rep_date <- sex_rep_date %>% ggplot(aes(x = rep_date, y = cum_cases, fill = sex)) + geom_area(show.legend = FALSE)
```

### Total by Sex Side-by-Side (Visualised)
```{r}
grid.arrange(cum_tot_rep_date, sexplot_rep_date, nrow = 2)
```

## 2.2 Cumulative Deaths

```{r}
inf_HH %>%
  transmute(total_of_confirmed_deaths = cumsum(amount_death)) %>%
  slice_tail()
```

### Cumulative Total of Confirmed Deaths (Visualised)
By `ref_date`:
```{r}
inf_HH %>% select(ref_date, amount_death) %>%
  arrange(ref_date) %>% 
  group_by(ref_date) %>% 
  summarise(amount_death = sum(amount_death)) %>%
  mutate(cumulative_deaths = cumsum(amount_death)) %>%
  ggplot(aes(ref_date, cumulative_deaths)) + geom_area()

cum_tot_ref_date_deaths <- inf_HH %>% select(ref_date, amount_death) %>%
  arrange(ref_date) %>% 
  group_by(ref_date) %>% 
  summarise(amount_death = sum(amount_death)) %>%
  mutate(cumulative_deaths = cumsum(amount_death)) %>%
  ggplot(aes(ref_date, cumulative_deaths)) + geom_area()

```

By `rep_date`:
```{r}
inf_HH %>% select(rep_date, amount_death) %>%
  arrange(rep_date) %>% 
  group_by(rep_date) %>% 
  summarise(amount_death = sum(amount_death)) %>%
  mutate(cumulative_deaths = cumsum(amount_death)) %>%
  ggplot(aes(rep_date, cumulative_deaths)) + geom_area()

cum_tot_rep_date_deaths <- inf_HH %>% select(rep_date, amount_death) %>%
  arrange(rep_date) %>% 
  group_by(rep_date) %>% 
  summarise(amount_death = sum(amount_death)) %>%
  mutate(cumulative_deaths = cumsum(amount_death)) %>%
  ggplot(aes(rep_date, cumulative_deaths)) + geom_area()

```
#### Sorted By Age Group Descending
```{r}
inf_HH %>% 
  group_by(age_group) %>% 
  transmute(total_of_confirmed_deaths = cumsum(amount_death)) %>%
  slice_tail() %>% 
  arrange(desc(total_of_confirmed_deaths))
```

### Cumulative Total of Confirmed Deaths by Age Bracket
By `ref_date`:
```{r}
AAll_ref_date_deaths <- df_age_brackets_ref_date_deaths()

AAll_ref_date_deaths %>% ggplot(aes(x = ref_date, y = cum_cases, fill = age_group)) + geom_area()

AAllplot_ref_date_deaths <- AAll_ref_date_deaths %>% ggplot(aes(x = ref_date, y = cum_cases, fill = age_group)) + geom_area(show.legend = FALSE)
```
### Total and by Age Bracket - Side-by-Side
```{r}
grid.arrange(cum_tot_ref_date_deaths, AAllplot_ref_date_deaths, nrow = 2)
```

By `rep_date`:
```{r}
AAll_rep_date_deaths <- df_age_brackets_rep_date_deaths()

AAll_rep_date_deaths %>% ggplot(aes(x = rep_date, y = cum_cases, fill = age_group)) + geom_area()

AAllplot_rep_date_deaths <- AAll_rep_date_deaths %>% ggplot(aes(x = rep_date, y = cum_cases, fill = age_group)) + geom_area(show.legend = FALSE)
```

### Total and by Age Bracket - Side-by-Side
```{r}
grid.arrange(cum_tot_rep_date_deaths, AAllplot_rep_date_deaths, nrow = 2)
```
#### Sorted by Sex
```{r}
inf_HH %>%
  group_by(sex) %>% 
  transmute(total_of_confirmed_deaths = cumsum(amount_death)) %>%
  slice_tail() %>% 
  arrange(desc(total_of_confirmed_deaths))
```

### Cumulative Total of Confirmed Deaths by Sex (Visualised)
By `ref_date`:
```{r}
sex_ref_date_deaths <- df_sex_ref_date_deaths()

sex_ref_date_deaths %>% ggplot(aes(x = ref_date, y = cum_cases, fill = sex)) + geom_area()

sexplot_ref_date_deaths <- sex_ref_date_deaths %>% ggplot(aes(x = ref_date, y = cum_cases, fill = sex)) + geom_area(show.legend = FALSE)
```
### Total by Sex Side-by-Side (Visualised)
```{r}
grid.arrange(cum_tot_ref_date_deaths, sexplot_ref_date_deaths, nrow = 2)
```

By `rep_date`:
```{r}
sex_rep_date_deaths <- df_sex_rep_date_deaths()

sex_rep_date_deaths %>% ggplot(aes(x = rep_date, y = cum_cases, fill = sex)) + geom_area()

sexplot_rep_date_deaths <- sex_rep_date_deaths %>% ggplot(aes(x = rep_date, y = cum_cases, fill = sex)) + geom_area(show.legend = FALSE)
```

### Total by Sex Side-by-Side (Visualised)
```{r}
grid.arrange(cum_tot_rep_date_deaths, sexplot_rep_date_deaths, nrow = 2)
```

## 2.2 Cumulative Recoveries

```{r}
inf_HH %>%
  transmute(total_of_confirmed_recoveries = cumsum(amount_recovery)) %>%
  slice_tail()
```

### Cumulative Total of Confirmed Recoveries (Visualised)
By `ref_date`
```{r}
inf_HH %>% select(ref_date, amount_recovery) %>%
  arrange(ref_date) %>% 
  group_by(ref_date) %>% 
  summarise(amount_recovery = sum(amount_recovery)) %>%
  mutate(cumulative_deaths = cumsum(amount_recovery)) %>%
  ggplot(aes(ref_date, cumulative_deaths)) + geom_area()

cum_tot_ref_date_recoveries <- inf_HH %>% select(ref_date, amount_recovery) %>%
  arrange(ref_date) %>% 
  group_by(ref_date) %>% 
  summarise(amount_recovery = sum(amount_recovery)) %>%
  mutate(cumulative_deaths = cumsum(amount_recovery)) %>%
  ggplot(aes(ref_date, cumulative_deaths)) + geom_area()

```

By `rep_date`
```{r}
inf_HH %>% select(rep_date, amount_recovery) %>%
  arrange(rep_date) %>% 
  group_by(rep_date) %>% 
  summarise(amount_recovery = sum(amount_recovery)) %>%
  mutate(cumulative_deaths = cumsum(amount_recovery)) %>%
  ggplot(aes(rep_date, cumulative_deaths)) + geom_area()

cum_tot_rep_date_recoveries <- inf_HH %>% select(rep_date, amount_recovery) %>%
  arrange(rep_date) %>% 
  group_by(rep_date) %>% 
  summarise(amount_recovery = sum(amount_recovery)) %>%
  mutate(cumulative_deaths = cumsum(amount_recovery)) %>%
  ggplot(aes(rep_date, cumulative_deaths)) + geom_area()
```

#### Sorted by Age Bracket Descending
```{r}
inf_HH %>%
  group_by(age_group) %>% 
  transmute(total_of_confirmed_recoveries = cumsum(amount_recovery)) %>%
  slice_tail() %>%
  arrange(desc(total_of_confirmed_recoveries))
```

### Cumulative Total of Confirmed Deaths by Age Bracket
By `ref_date`:
```{r}
AAll_ref_date_recoveries <- df_age_brackets_ref_date_recoveries()

AAll_ref_date_recoveries %>% ggplot(aes(x = ref_date, y = cum_cases, fill = age_group)) + geom_area()

AAllplot_ref_date_recoveries <- AAll_ref_date_recoveries %>% ggplot(aes(x = ref_date, y = cum_cases, fill = age_group)) + geom_area(show.legend = FALSE)
```
### Total and by Age Bracket - Side-by-Side
```{r}
grid.arrange(cum_tot_ref_date_recoveries, AAllplot_ref_date_recoveries, nrow = 2)
```

By `rep_date`:
```{r}
AAll_ref_date_recoveries <- df_age_brackets_ref_date_recoveries()

AAll_ref_date_recoveries %>% ggplot(aes(x = ref_date, y = cum_cases, fill = age_group)) + geom_area()

AAllplot_rep_date_recoveries <- AAll_ref_date_recoveries %>% ggplot(aes(x = ref_date, y = cum_cases, fill = age_group)) + geom_area(show.legend = FALSE)
```

### Total and by Age Bracket - Side-by-Side
```{r}
grid.arrange(cum_tot_rep_date_recoveries, AAllplot_rep_date_recoveries, nrow = 2)
```

#### Sorted by Sex
```{r}
inf_HH %>%
  group_by(sex) %>% 
  transmute(total_of_confirmed_recoveries = cumsum(amount_recovery)) %>%
  slice_tail() %>% 
  arrange(desc(total_of_confirmed_recoveries))
```

### Cumulative Total of Confirmed Recoveries by Sex (Visualised)
By `ref_date`:
```{r}
sex_ref_date_recoveries <- df_sex_ref_date_recoveries()

sex_ref_date_recoveries %>% ggplot(aes(x = ref_date, y = cum_cases, fill = sex)) + geom_area()

sexplot_ref_date_recoveries <- sex_ref_date_recoveries %>% ggplot(aes(x = ref_date, y = cum_cases, fill = sex)) + geom_area(show.legend = FALSE)
```
### Total by Sex Side-by-Side (Visualised)
```{r}
grid.arrange(cum_tot_ref_date_recoveries, sexplot_ref_date_recoveries, nrow = 2)
```
By `rep_date`:
```{r}
sex_rep_date_recoveries <- df_sex_rep_date_recoveries()

sex_rep_date_recoveries %>% ggplot(aes(x = rep_date, y = cum_cases, fill = sex)) + geom_area()

sexplot_rep_date_recoveries <- sex_rep_date_recoveries %>% ggplot(aes(x = rep_date, y = cum_cases, fill = sex)) + geom_area(show.legend = FALSE)
```

### Total by Sex Side-by-Side (Visualised)
```{r}
grid.arrange(cum_tot_rep_date_recoveries, sexplot_rep_date_recoveries, nrow = 2)
```